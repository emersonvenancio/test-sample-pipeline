WITH product AS (
    SELECT
        productname AS mdmname,
        productname AS mdmdescription,
        productprice AS mdmunitvalue,
        bar_code AS mdmbarcode,
        image AS mdmimage,
        true AS __resolveGeolocation,
        category AS mdmcategoryname,
        (SELECT AS STRUCT CAST(variations.quantity AS INT64) AS mdmquantity, variations.name AS mdmname) AS mdmvariations,
       ARRAY(
            SELECT AS STRUCT 
                'Default' AS mdmaddresstype,
                'Manoel Alberto Alves' AS mdmaddress1,
                'Rio Claro' AS mdmaddress2,
                'Casa' AS mdmaddress3,
                '78435000' AS mdmzipcode,
                'São José do Rio Claro' AS mdmcity,
                'MT' AS mdmstate,
                'Brasil' AS mdmcountry
            
            UNION ALL
            
            SELECT AS STRUCT 
                'Default' AS mdmaddresstype,
                'Redentora' AS mdmaddress1,
                'Centro' AS mdmaddress2,
                'Casa' AS mdmaddress3,
                '78640970' AS mdmzipcode,
                'Canarana' AS mdmcity,
                'MT' AS mdmstate,
                'Brasil' AS mdmcountry
        ) AS mdmaddress,
        '{"lat":-34.83759307861328,"lon":-7.068934440612793}' AS homeplace
        --metadata--
    FROM
        stg_nlp_product as stg
        CROSS JOIN UNNEST(variations) AS variations
    WHERE
        1 = 1
        --timestamp-- OR mdmCounterForEntity > {{start_from}}
)

SELECT
    *,
    (
        (mdmname IS NULL) 
        OR (LENGTH(TRIM(mdmname)) = 0)
        OR (mdmcategoryname IS NULL)
        OR (LENGTH(TRIM(mdmcategoryname)) = 0)
    ) AS mdmDeleted
FROM
    product
